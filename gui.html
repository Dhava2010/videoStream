<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Quadrant Robot Controller (Web GUI)</title>
    <style>
        /* Ensures the table and its cells fill the entire viewport */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        table {
            border-collapse: collapse; /* Make borders look nicer */
            table-layout: fixed; /* Ensures column widths are respected */
        }
        td {
            border: 1px solid black;
            padding: 0;
        }
        /* Style for the video stream images */
        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Scale image to fit, preserving aspect ratio */
            display: block; /* Removes any default spacing */
        }
        /* Style for the control quadrant */
        #control-quadrant {
            background-color: #1a1a1a;
            text-align: center;
        }
        /* Style for the console quadrant */
        #console-quadrant {
            background-color: #2d2d2d;
        }
        .control-table {
            height: 100%;
            width: 100%;
            table-layout: fixed;
            border-collapse: separate;
        }
        .control-table button {
            font-size: 40px;
            width: 100px;
            height: 100px;
            cursor: pointer;
            border-radius: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            transition: background-color 0.1s;
        }
        .control-table button:active {
            background-color: #3e8e41;
        }
        #stop-button {
            background-color: #f44336;
        }
        #stop-button:active {
            background-color: #d32f2f;
        }
        #log-area {
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            background-color: #121212;
            color: lightgray;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            border: none;
            resize: none;
            padding: 5px;
        }
    </style>
</head>
<body>
    <table width="100%" height="100%">
        <tr>
            <td id="video1-quadrant" width="50%" height="50%" style="background-color: #4f4f4f;">
                <img id="video-stream-1" class="video-feed" src="http://192.168.240.16:5001/video_feed" alt="Video Stream 1">
            </td>

            <td id="control-quadrant" width="50%" height="50%">
                <table class="control-table">
                    <tr>
                        <td></td>
                        <td align="center" valign="middle">
                            <button type="button" onclick="sendCommand('forward')" ontouchstart="sendCommand('forward')" ontouchend="sendCommand('stop')">&uarr;</button>
                        </td>
                        <td></td>
                    </tr>
                    <tr>
                        <td align="center" valign="middle">
                            <button type="button" onclick="sendCommand('left')" ontouchstart="sendCommand('left')" ontouchend="sendCommand('stop')">&larr;</button>
                        </td>
                        <td align="center" valign="middle">
                            <button id="stop-button" type="button" onclick="sendCommand('stop')">STOP</button>
                        </td>
                        <td align="center" valign="middle">
                            <button type="button" onclick="sendCommand('right')" ontouchstart="sendCommand('right')" ontouchend="sendCommand('stop')">&rarr;</button>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td align="center" valign="middle">
                            <button type="button" onclick="sendCommand('backward')" ontouchstart="sendCommand('backward')" ontouchend="sendCommand('stop')">&darr;</button>
                        </td>
                        <td></td>
                    </tr>
                </table>
            </td>
        </tr>

        <tr>
            <td id="video2-quadrant" width="50%" height="50%" style="background-color: #3b3b3b;">
                <img id="video-stream-2" class="video-feed" src="http://192.168.240.16:5001/video_feed" alt="Video Stream 2">
            </td>

            <td id="console-quadrant" width="50%" height="50%">
                <textarea id="log-area" readonly placeholder="API Command Log..."></textarea>
            </td>
        </tr>
    </table>

    <script>
        const API_URL = 'http://192.168.240.4:5000/controls';
        const logArea = document.getElementById('log-area');

        function logMessage(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            logArea.value += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function sendCommand(direction) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ direction: direction })
                });

                const data = await response.json();
                
                if (response.ok) {
                    logMessage(`Sent: ${direction} | Status: ${response.status} | Server State: ${data.direction}`);
                } else {
                    logMessage(`API Error (${response.status}): ${data.message || 'Unknown error'}`, true);
                }
            } catch (error) {
                logMessage(`Network error during API call. Check if the Flask server is running at ${API_URL}.`, true);
            }
        }

        window.addEventListener('keydown', (event) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(event.key)) {
                event.preventDefault();
            }

            let directionToSend = null;
            switch (event.key) {
                case 'ArrowUp':    directionToSend = 'forward';  break;
                case 'ArrowDown':  directionToSend = 'backward'; break;
                case 'ArrowLeft':  directionToSend = 'left';     break;
                case 'ArrowRight': directionToSend = 'right';    break;
                case ' ':          directionToSend = 'stop';     break;
                default:           return;
            }

            if (directionToSend) sendCommand(directionToSend);
        });
    </script>
</body>
</html>
